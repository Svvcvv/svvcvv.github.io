<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片强压到48KB内</title>
    <style>
        * { box-sizing: border-box; margin: 10px; font-family: Arial, sans-serif; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .preview { width: 200px; height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .info { color: #666; white-space: pre-line; }
    </style>
</head>
<body>
    <div class="container">
        <h3>图片压缩（到≤47.997KB）</h3>
        <input type="file" id="fileInput" accept="image/*">
        <div class="preview" id="previewContainer"><span>预览</span></div>
        <button id="compressBtn" disabled>开始压缩</button>
        <button id="downloadBtn" disabled>下载</button>
        <div class="info" id="infoText">
            PS:这个网页是AI 1min写出来的，需要加功能尽管私我
            <img src="que/qrcode.png" width="100px">
        </div>
    </div>

    <script>
        // 精确上限：TEXT字段能存的最大原图 = 49149 字节
        const MAX_SIZE = 49149;
        const TARGET_MIME = 'image/webp';

        let file = null;
        let resultBlob = null;

        const $ = s => document.querySelector(s);

        $('#fileInput').addEventListener('change', e => {
            file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            $('#previewContainer').innerHTML = `<img src="${URL.createObjectURL(file)}">`;
            $('#infoText').textContent = `原始：${(file.size/1024).toFixed(2)} KB`;
            $('#compressBtn').disabled = false;
            $('#downloadBtn').disabled = true;
        });

        $('#compressBtn').addEventListener('click', async () => {
            $('#compressBtn').disabled = true;
            $('#infoText').textContent = "压缩中（尺寸+质量双压缩）...";
            try {
                resultBlob = await compressToTargetSize(file, MAX_SIZE);
                $('#previewContainer').innerHTML = `<img src="${URL.createObjectURL(resultBlob)}">`;
                $('#infoText').textContent = 
                    `✅ 压缩成功！\n原始：${(file.size/1024).toFixed(2)} KB\n最终：${(resultBlob.size/1024).toFixed(2)} KB\n目标：≤47.997 KB`;
                $('#downloadBtn').disabled = false;
            } catch (e) {
                $('#infoText').textContent = "❌ 压缩失败：" + e.message;
                $('#compressBtn').disabled = false;
            }
        });

        $('#downloadBtn').addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(resultBlob);
            a.download = "avatar_compressed.webp";
            a.click();
        });

        /**
         * 核心：先缩尺寸 → 再降质量，循环直到 ≤ maxBytes
         */
        function compressToTargetSize(file, maxBytes) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let ctx = canvas.getContext('2d');
                    let quality = 0.8;
                    let scale = 1.0;
                    let w = img.width, h = img.height;
                    let attempt = 0;
                    const maxAttempt = 50;

                    function run() {
                        attempt++;
                        if (attempt > maxAttempt) return reject("已尝试50次仍无法压到目标大小");

                        // 尺寸缩放
                        const nw = Math.round(w * scale);
                        const nh = Math.round(h * scale);
                        canvas.width = nw;
                        canvas.height = nh;
                        ctx.clearRect(0,0,nw,nh);
                        ctx.drawImage(img, 0,0,nw,nh);

                        canvas.toBlob(blob => {
                            if (blob.size <= maxBytes || quality < 0.1 || scale < 0.1) {
                                return resolve(blob);
                            }
                            // 太大：优先缩尺寸，尺寸很小了再降质量
                            if (scale > 0.4) scale *= 0.8;
                            else quality -= 0.1;
                            run();
                        }, TARGET_MIME, quality);
                    }
                    run();
                };
                img.onerror = () => reject("图片加载失败");
                img.src = URL.createObjectURL(file);
            });
        }
    </script>
</body>
</html>