<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试友谊的时刻到啦！</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                        <i class="fa fa-heart text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">测试友谊的时刻到啦！</h1>
                </div>
                <div id="userInfo" class="hidden items-center space-x-4">
                    <span class="text-gray-700 font-medium"></span>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 transition-colors">
                        <i class="fa fa-sign-out"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- 登录界面 -->
        <div id="loginSection" class="py-12">
            <div class="max-w-md mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa fa-users text-white text-2xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">测试友谊的时刻到啦！</h2>
                        <p class="text-gray-600">你对726了解多少？</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                            <input type="text" id="username" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                   placeholder="请输入用户名" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                            <input type="password" id="password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                   placeholder="请输入密码" required>
                        </div>
                        <button type="submit" 
                                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-6 rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 duration-200">
                            <i class="fa fa-sign-in mr-2"></i>开始测试
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 测试已完成提示 -->
        <div id="alreadyCompletedSection" class="hidden py-12">
            <div class="max-w-md mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-orange-400 to-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-check-circle text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">测试已完成</h2>
                    <p class="text-gray-600 mb-6">每个账户只能参与一次测试，感谢您的参与！</p>
                    <button onclick="showResult()" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg font-medium hover:from-blue-600 hover:to-cyan-600 transition-all">
                        <i class="fa fa-bar-chart mr-2"></i>查看成绩
                    </button>
                </div>
            </div>
        </div>

        <!-- 测试界面 -->
        <div id="quizSection" class="hidden py-12">
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                <!-- 进度条 -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">测试进度</span>
                        <span id="progressText" class="text-sm font-medium text-purple-600">1/2</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
                    </div>
                </div>

                <!-- 问题容器 -->
                <div id="questionContainer" class="space-y-8">
                    <!-- 问题将通过JavaScript动态生成 -->
                </div>

                <!-- 导航按钮 -->
                <div class="flex justify-between mt-12">
                    <button id="prevBtn" onclick="previousQuestion()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-arrow-left mr-2"></i>上一题
                    </button>
                    <button id="nextBtn" onclick="nextQuestion()" 
                            class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一题<i class="fa fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 结果界面 -->
        <div id="resultSection" class="hidden py-12">
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover text-center">
                <div class="mb-8">
                    <div class="w-24 h-24 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-trophy text-white text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">测试完成！</h2>
                    <p class="text-gray-600">恭喜你完成了默契测试</p>
                </div>

                <!-- 成绩显示 -->
                <div class="mb-8">
                    <div class="text-7xl font-bold text-gradient bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-4" id="finalScore">0</div>
                    <p class="text-xl text-gray-700 mb-2">
                        答对 <span id="correctCount" class="font-bold text-green-600">0</span> 题
                    </p>
                    <p class="text-gray-600">共 <span id="totalCount" class="font-medium">2</span> 题</p>
                </div>

                <!-- 默契等级 -->
                <div class="mb-8">
                    <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium" id="levelBadge">
                        <i class="fa fa-star mr-2"></i>默契等级
                    </div>
                    <p id="levelDescription" class="text-gray-600 mt-2"></p>
                </div>

                <!-- 操作按钮 -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showRanking()" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg font-medium hover:from-blue-600 hover:to-cyan-600 transition-all">
                        <i class="fa fa-bar-chart mr-2"></i>查看排行榜
                    </button>
                    <button onclick="logout()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                        <i class="fa fa-sign-out mr-2"></i>退出登录
                    </button>
                </div>
            </div>
        </div>

        <!-- 排行榜界面 -->
        <div id="rankingSection" class="hidden py-12">
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-trophy text-white text-2xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">默契排行榜</h2>
                    <p class="text-gray-600">看看谁和朋友最有默契</p>
                </div>

                <!-- 排行榜加载状态 -->
                <div id="rankingLoading" class="text-center py-12">
                    <div class="animate-spin w-12 h-12 border-4 border-purple-200 border-t-purple-500 rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-600">正在加载排行榜数据...</p>
                </div>

                <!-- 排行榜内容 -->
                <div id="rankingContent" class="hidden">
                    <div class="space-y-4" id="rankingList">
                        <!-- 排行榜项目将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 回到结果按钮 -->
                <div class="text-center mt-8">
                    <button onclick="showResult()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                        <i class="fa fa-arrow-left mr-2"></i>回到结果
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 测试数据
        const QUESTIONS = [
    {
        "id": "q1",
        "question": "他多高？",
        "type": "single",
        "options": [
            "175cm",
            "160cm",
            "180cm",
            "195cm"
        ],
        "correctAnswer": "C"
    },
    {
        "id": "q2",
        "question": "这个HTML是谁做的？",
        "type": "multiple",
        "options": [
            "doubao",
            "726",
            "705"
        ],
        "correctAnswer": [
            "A",
            "B"
        ]
    }
];
        const USERS = [
    {
        "username": "705",
        "passwordHash": "30aa05fdb0e292baaef648a853d3202dded02ffd5a51f37d338d2864cba79710"
    },
    {
        "username": "Public",
        "passwordHash": "a1159e9df3670d549d04524532629f5477ceb7deec9b45e47e8c009506ecb2c8"
    }
];
        const API_KEY = "nOhCXXRtxnemH4STy6RRP1vKmW91FClN";
        const TEST_ID = "cmoPRN8WnzHQ0PCk";
        const MAX_ATTEMPTS = 1;
        const ENCRYPTION_SECRET = "H8qpEEkcA4Tjbh1C";
        
        // 全局变量
        let currentUser = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizCompleted = false;
        let userAttempts = 0;

        // DOM 元素
        const loginSection = document.getElementById('loginSection');
        const alreadyCompletedSection = document.getElementById('alreadyCompletedSection');
        const quizSection = document.getElementById('quizSection');
        const resultSection = document.getElementById('resultSection');
        const rankingSection = document.getElementById('rankingSection');
        const questionContainer = document.getElementById('questionContainer');
        const userInfo = document.getElementById('userInfo');

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            console.log('应用初始化');
            initializeApp();
        });

        function initializeApp() {
            // 检查是否有保存的登录状态
            const savedUser = localStorage.getItem('currentUser_' + TEST_ID);
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    checkUserAttempts();
                } catch (error) {
                    console.error('加载保存的用户状态失败:', error);
                    localStorage.removeItem('currentUser_' + TEST_ID);
                    showLogin();
                }
            } else {
                showLogin();
            }

            // 绑定登录表单事件
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleLogin();
                });
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showAlert('请输入用户名和密码', 'error');
                return;
            }

            try {
                const passwordHash = await sha256(password);
                const user = USERS.find(u => u.username === username && u.passwordHash === passwordHash);

                if (user) {
                    currentUser = { username: user.username };
                    localStorage.setItem('currentUser_' + TEST_ID, JSON.stringify(currentUser));
                    await checkUserAttempts();
                    showAlert('登录成功！', 'success');
                } else {
                    showAlert('用户名或密码错误', 'error');
                }
            } catch (error) {
                console.error('登录过程中发生错误:', error);
                showAlert('登录失败，请重试', 'error');
            }
        }

        async function checkUserAttempts() {
            try {
                // 获取用户答题记录
                const userRecords = await getUserRecords(currentUser.username);
                userAttempts = userRecords.length;

                if (userAttempts >= MAX_ATTEMPTS) {
                    // 显示已完成界面
                    showAlreadyCompleted();
                    // 尝试获取上次成绩
                    if (userRecords.length > 0) {
                        const lastRecord = userRecords[userRecords.length - 1];
                        // 解密答案
                        try {
                            const decryptedAnswers = await decryptAnswers(lastRecord.encryptedAnswers);
                            userAnswers = decryptedAnswers;
                        } catch (error) {
                            console.error('解密答案失败:', error);
                        }
                    }
                } else {
                    // 显示测试界面
                    showQuiz();
                    renderQuestion();
                    updateUserInfo();
                }
            } catch (error) {
                console.error('检查答题次数失败:', error);
                showQuiz();
                renderQuestion();
                updateUserInfo();
            }
        }

        async function getUserRecords(username) {
            try {
                const records = [];
                
                // 从localStorage获取
                const savedRecords = JSON.parse(localStorage.getItem('quizRecords_' + TEST_ID) || '[]');
                const userLocalRecords = savedRecords.filter(record => record.username === username);
                records.push(...userLocalRecords);
                
                // 从API获取
                try {
                    const response = await fetch(`https://textdb.online/${API_KEY}`);
                    if (response.ok) {
                        const apiData = await response.text();
                        if (apiData) {
                            const apiRecord = JSON.parse(apiData);
                            if (apiRecord.username === username) {
                                records.push(apiRecord);
                            }
                        }
                    }
                } catch (apiError) {
                    console.warn('API获取失败，使用localStorage数据:', apiError);
                }
                
                // 去重并按时间排序
                const uniqueRecords = Array.from(new Map(records.map(item => [item.timestamp, item])).values());
                return uniqueRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (error) {
                console.error('获取用户记录失败:', error);
                return [];
            }
        }

        function sha256(str) {
            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(str))
                .then(digest => {
                    return Array.from(new Uint8Array(digest))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                });
        }

        async function encryptAnswers(answers) {
            try {
                const answersStr = JSON.stringify(answers);
                const encoder = new TextEncoder();
                const data = encoder.encode(answersStr);
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_SECRET),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(TEST_ID),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                return {
                    iv: Array.from(iv).map(b => b.toString(16).padStart(2, '0')).join(''),
                    data: Array.from(new Uint8Array(encrypted)).map(b => b.toString(16).padStart(2, '0')).join('')
                };
            } catch (error) {
                console.error('加密答案失败:', error);
                throw error;
            }
        }

        async function decryptAnswers(encryptedData) {
            try {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_SECRET),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(TEST_ID),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                const iv = new Uint8Array(encryptedData.iv.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                const data = new Uint8Array(encryptedData.data.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (error) {
                console.error('解密答案失败:', error);
                throw error;
            }
        }

        function renderQuestion() {
            if (currentQuestionIndex >= QUESTIONS.length) {
                showResult();
                return;
            }

            const question = QUESTIONS[currentQuestionIndex];
            
            let optionsHtml = '';
            const inputType = question.type === 'multiple' ? 'checkbox' : 'radio';
            
            for (let i = 0; i < question.options.length; i++) {
                const optionKey = String.fromCharCode(65 + i);
                const isSelected = question.type === 'multiple' 
                    ? (userAnswers[question.id] || []).includes(optionKey)
                    : userAnswers[question.id] === optionKey;
                
                optionsHtml += `
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-200 ${isSelected ? 'border-primary bg-primary/5 ring-2 ring-primary/20' : ''}">
                        <input type="${inputType}" name="${question.id}" value="${optionKey}" 
                               class="w-5 h-5 text-primary focus:ring-primary"
                               ${isSelected ? 'checked' : ''} onchange="selectAnswer('${question.id}', '${optionKey}', '${question.type}')">
                        <span class="flex-1 ml-4 ${isSelected ? 'text-primary font-medium' : 'text-gray-700'}">
                            <strong class="text-lg">${optionKey}.</strong> ${question.options[i]}
                        </span>
                    </label>
                `;
            }

            // 添加题目类型提示
            let questionTypeHtml = '';
            if (question.type === 'multiple') {
                questionTypeHtml = `
                    <div class="mb-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fa fa-check-square-o mr-1"></i>多选题（可选择多个答案）
                        </span>
                    </div>
                `;
            }

            questionContainer.innerHTML = `
                <div class="question-card animate-fade-in">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full flex items-center justify-center font-bold text-lg mr-4">
                            ${currentQuestionIndex + 1}
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">${question.question}</h3>
                    </div>
                    
                    ${questionTypeHtml}

                    <div class="space-y-3">
                        ${optionsHtml}
                    </div>
                </div>
            `;

            updateProgress();
            updateNavigation();
        }

        function selectAnswer(questionId, option, questionType) {
            if (questionType === 'multiple') {
                // 多选题逻辑
                if (!userAnswers[questionId]) {
                    userAnswers[questionId] = [];
                }
                const index = userAnswers[questionId].indexOf(option);
                if (index > -1) {
                    userAnswers[questionId].splice(index, 1);
                } else {
                    userAnswers[questionId].push(option);
                }
            } else {
                // 单选题逻辑
                userAnswers[questionId] = option;
            }
            
            updateNavigation();
            
            // 添加选择动画
            const label = document.querySelector(`input[value="${option}"][name="${questionId}"]`).closest('label');
            if (label) {
                label.classList.add('scale-102');
                setTimeout(() => label.classList.remove('scale-102'), 200);
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / QUESTIONS.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentQuestionIndex + 1}/${QUESTIONS.length}`;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentQuestion = QUESTIONS[currentQuestionIndex];

            prevBtn.disabled = currentQuestionIndex === 0;
            
            // 检查是否已选择答案
            let hasAnswer = false;
            if (currentQuestion.type === 'multiple') {
                hasAnswer = (userAnswers[currentQuestion.id] || []).length > 0;
            } else {
                hasAnswer = !!userAnswers[currentQuestion.id];
            }
            
            nextBtn.disabled = !hasAnswer;

            // 更新按钮文本
            if (currentQuestionIndex === QUESTIONS.length - 1) {
                nextBtn.innerHTML = '<i class="fa fa-check mr-2"></i>提交答案';
            } else {
                nextBtn.innerHTML = '下一题<i class="fa fa-arrow-right ml-2"></i>';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < QUESTIONS.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
                
                // 滚动到顶部
                window.scrollTo({top: 0, behavior: 'smooth'});
            } else {
                submitQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
                
                // 滚动到顶部
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        async function submitQuiz() {
            if (quizCompleted) return;

            try {
                // 计算得分
                let correct = 0;
                QUESTIONS.forEach(question => {
                    if (question.type === 'multiple') {
                        // 多选题得分逻辑：所有正确答案都选对才算对
                        const userAnswer = userAnswers[question.id] || [];
                        const correctAnswers = question.correctAnswer;
                        const isAllCorrect = correctAnswers.every(answer => userAnswer.includes(answer));
                        const noExtraAnswers = userAnswer.every(answer => correctAnswers.includes(answer));
                        if (isAllCorrect && noExtraAnswers) {
                            correct++;
                        }
                    } else {
                        // 单选题得分逻辑
                        if (userAnswers[question.id] === question.correctAnswer) {
                            correct++;
                        }
                    }
                });

                const score = Math.round((correct / QUESTIONS.length) * 100);
                
                // 加密答案
                const encryptedAnswers = await encryptAnswers(userAnswers);
                
                // 保存成绩
                await saveScore(score, correct, encryptedAnswers);
                
                quizCompleted = true;
                showResult();
            } catch (error) {
                console.error('提交测试过程中发生错误:', error);
                showAlert('提交失败，请重试', 'error');
            }
        }

        async function saveScore(score, correctAnswers, encryptedAnswers) {
            try {
                const scoreData = {
                    username: currentUser.username,
                    score: score,
                    correctAnswers: correctAnswers,
                    totalQuestions: QUESTIONS.length,
                    timestamp: new Date().toISOString(),
                    testId: TEST_ID,
                    encryptedAnswers: encryptedAnswers
                };

                // 保存到localStorage（备用）
                const savedRecords = JSON.parse(localStorage.getItem('quizRecords_' + TEST_ID) || '[]');
                savedRecords.push(scoreData);
                localStorage.setItem('quizRecords_' + TEST_ID, JSON.stringify(savedRecords));

                // 尝试保存到API
                try {
                    const response = await fetch(`https://api.textdb.online/update/?key=${API_KEY}&value=${encodeURIComponent(JSON.stringify(scoreData))}`);
                    if (!response.ok) {
                        console.warn('API保存失败，使用localStorage');
                    }
                } catch (apiError) {
                    console.warn('API调用失败，使用localStorage:', apiError);
                }

                return scoreData;
            } catch (error) {
                console.error('保存成绩失败:', error);
                throw error;
            }
        }

        function showResult() {
            const correct = Object.values(userAnswers).filter((answer, index) => {
                const question = QUESTIONS[index];
                if (question.type === 'multiple') {
                    const userAnswer = answer || [];
                    const correctAnswers = question.correctAnswer;
                    return correctAnswers.every(a => userAnswer.includes(a)) && 
                           userAnswer.every(a => correctAnswers.includes(a));
                } else {
                    return answer === question.correctAnswer;
                }
            }).length;
            
            const score = Math.round((correct / QUESTIONS.length) * 100);
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('totalCount').textContent = QUESTIONS.length;
            
            // 更新默契等级
            updateLevel(score);
            
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // 滚动到顶部
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateLevel(score) {
            const levelBadge = document.getElementById('levelBadge');
            const levelDescription = document.getElementById('levelDescription');
            
            let level, color, icon, description;
            
            if (score >= 90) {
                level = '完美默契';
                color = 'bg-gradient-to-r from-yellow-400 to-orange-500';
                icon = 'fa-diamond';
                description = '你们简直是心灵相通的最佳拍档！';
            } else if (score >= 80) {
                level = '高度默契';
                color = 'bg-gradient-to-r from-blue-500 to-cyan-500';
                icon = 'fa-star';
                description = '你们有着非常好的默契，彼此很了解！';
            } else if (score >= 70) {
                level = '良好默契';
                color = 'bg-gradient-to-r from-green-500 to-emerald-500';
                icon = 'fa-thumbs-up';
                description = '你们的默契不错，继续保持！';
            } else if (score >= 60) {
                level = '一般默契';
                color = 'bg-gradient-to-r from-purple-500 to-pink-500';
                icon = 'fa-heart';
                description = '你们有一定默契，还可以更了解彼此！';
            }  else if (score >= 40) {
                level = '需要努力';
                color = 'bg-gradient-to-r from-red-500 to-pink-500';
                icon = 'fa-heart-o';
                description = '我们n年的同学情谊呢?!!';
            }  else if (score <= 20) {
                level = '你谁啊！';
                color = 'bg-gradient-to-r from-red-500 to-pink-500';
                icon = 'fa-heart-o';
                description = '纯蒙的都比你强';
            }else {
                level = '需要努力';
                color = 'bg-gradient-to-r from-red-500 to-pink-500';
                icon = 'fa-heart-o';
                description = '加油！多了解朋友，增进彼此的默契吧！';
            }
            
            levelBadge.className = `inline-flex items-center px-4 py-2 rounded-full text-sm font-medium text-white ${color}`;
            levelBadge.innerHTML = `<i class="fa ${icon} mr-2"></i>${level}`;
            levelDescription.textContent = description;
        }

        async function showRanking() {
            resultSection.classList.add('hidden');
            rankingSection.classList.remove('hidden');
            
            try {
                const rankings = await getRankings();
                displayRankings(rankings);
            } catch (error) {
                console.error('获取排行榜失败:', error);
                showAlert('加载排行榜失败', 'error');
            }
        }

        async function getRankings() {
            try {
                // 先从localStorage获取
                const savedRecords = JSON.parse(localStorage.getItem('quizRecords_' + TEST_ID) || '[]');
                
                // 尝试从API获取
                try {
                    const response = await fetch(`https://textdb.online/${API_KEY}`);
                    if (response.ok) {
                        const apiData = await response.text();
                        if (apiData) {
                            const apiRecord = JSON.parse(apiData);
                            savedRecords.push(apiRecord);
                        }
                    }
                } catch (apiError) {
                    console.warn('API获取失败，使用localStorage数据:', apiError);
                }
                
                // 去重和排序
                const uniqueRecords = Array.from(new Map(savedRecords.map(item => [item.username + item.timestamp, item])).values());
                return uniqueRecords.sort((a, b) => b.score - a.score);
            } catch (error) {
                console.error('获取排行榜数据失败:', error);
                return [];
            }
        }

        function displayRankings(rankings) {
            const rankingList = document.getElementById('rankingList');
            const rankingLoading = document.getElementById('rankingLoading');
            const rankingContent = document.getElementById('rankingContent');
            
            rankingLoading.classList.add('hidden');
            rankingContent.classList.remove('hidden');
            
            if (rankings.length === 0) {
                rankingList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fa fa-frown-o text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">暂无排名数据</p>
                    </div>
                `;
                return;
            }
            
            rankingList.innerHTML = rankings.map((item, index) => {
                const isCurrentUser = currentUser && item.username === currentUser.username;
                const medal = index < 3 ? ['🥇', '🥈', '🥉'][index] : `${index + 1}.`;
                
                return `
                    <div class="flex items-center justify-between p-4 rounded-lg transition-all duration-200 ${isCurrentUser ? 'bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200' : 'hover:bg-gray-50'}">
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl font-bold ${index < 3 ? '' : 'text-gray-500'}">${medal}</span>
                            <div>
                                <div class="font-medium ${isCurrentUser ? 'text-purple-600' : 'text-gray-900'}">${item.username}</div>
                                <div class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-purple-600">${item.score}</div>
                            <div class="text-sm text-gray-500">${item.correctAnswers}/${item.totalQuestions}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAlreadyCompleted() {
            loginSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
            alreadyCompletedSection.classList.remove('hidden');
            updateUserInfo();
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            alreadyCompletedSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
        }

        function showQuiz() {
            loginSection.classList.add('hidden');
            alreadyCompletedSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
        }

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                currentUser = null;
                currentQuestionIndex = 0;
                userAnswers = {};
                quizCompleted = false;
                userAttempts = 0;
                
                localStorage.removeItem('currentUser_' + TEST_ID);
                
                rankingSection.classList.add('hidden');
                resultSection.classList.add('hidden');
                quizSection.classList.add('hidden');
                alreadyCompletedSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
                
                // 清空登录表单
                document.getElementById('loginForm').reset();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                const userInfoText = userInfo.querySelector('span');
                userInfoText.textContent = `欢迎，${currentUser.username}`;
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
            } else {
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
        }

        function showAlert(message, type = 'info') {
            // 创建提示框
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 transition-all duration-300 transform translate-x-full`;
            
            switch(type) {
                case 'success':
                    alertDiv.classList.add('bg-green-500');
                    alertDiv.innerHTML = `<i class="fa fa-check mr-2"></i>${message}`;
                    break;
                case 'error':
                    alertDiv.classList.add('bg-red-500');
                    alertDiv.innerHTML = `<i class="fa fa-times mr-2"></i>${message}`;
                    break;
                default:
                    alertDiv.classList.add('bg-blue-500');
                    alertDiv.innerHTML = `<i class="fa fa-info mr-2"></i>${message}`;
            }
            
            document.body.appendChild(alertDiv);
            
            // 显示动画
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                alertDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 300);
            }, 3000);
        }

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fade-in 0.3s ease-out;
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>