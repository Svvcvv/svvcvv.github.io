<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å‹è°Šçš„æ—¶åˆ»åˆ°å•¦ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                        <i class="fa fa-heart text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">æµ‹è¯•å‹è°Šçš„æ—¶åˆ»åˆ°å•¦ï¼</h1>
                </div>
                <div id="userInfo" class="hidden items-center space-x-4">
                    <span class="text-gray-700 font-medium"></span>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 transition-colors">
                        <i class="fa fa-sign-out"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="loginSection" class="py-12">
            <div class="max-w-md mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa fa-users text-white text-2xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">æµ‹è¯•å‹è°Šçš„æ—¶åˆ»åˆ°å•¦ï¼</h2>
                        <p class="text-gray-600">ä½ å¯¹726äº†è§£å¤šå°‘ï¼Ÿ</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                            <input type="text" id="username" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                   placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                            <input type="password" id="password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                   placeholder="è¯·è¾“å…¥å¯†ç " required>
                        </div>
                        <button type="submit" 
                                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-6 rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 duration-200">
                            <i class="fa fa-sign-in mr-2"></i>å¼€å§‹æµ‹è¯•
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•å·²å®Œæˆæç¤º -->
        <div id="alreadyCompletedSection" class="hidden py-12">
            <div class="max-w-md mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-orange-400 to-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-check-circle text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">æµ‹è¯•å·²å®Œæˆ</h2>
                    <p class="text-gray-600 mb-6">æ¯ä¸ªè´¦æˆ·åªèƒ½å‚ä¸ä¸€æ¬¡æµ‹è¯•ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
                    <button onclick="showResult()" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg font-medium hover:from-blue-600 hover:to-cyan-600 transition-all">
                        <i class="fa fa-bar-chart mr-2"></i>æŸ¥çœ‹æˆç»©
                    </button>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•ç•Œé¢ -->
        <div id="quizSection" class="hidden py-12">
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                <!-- è¿›åº¦æ¡ -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">æµ‹è¯•è¿›åº¦</span>
                        <span id="progressText" class="text-sm font-medium text-purple-600">1/2</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
                    </div>
                </div>

                <!-- é—®é¢˜å®¹å™¨ -->
                <div id="questionContainer" class="space-y-8">
                    <!-- é—®é¢˜å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- å¯¼èˆªæŒ‰é’® -->
                <div class="flex justify-between mt-12">
                    <button id="prevBtn" onclick="previousQuestion()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-arrow-left mr-2"></i>ä¸Šä¸€é¢˜
                    </button>
                    <button id="nextBtn" onclick="nextQuestion()" 
                            class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ä¸‹ä¸€é¢˜<i class="fa fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»“æœç•Œé¢ -->
        <div id="resultSection" class="hidden py-12">
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover text-center">
                <div class="mb-8">
                    <div class="w-24 h-24 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-trophy text-white text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">æµ‹è¯•å®Œæˆï¼</h2>
                    <p class="text-gray-600">æ­å–œä½ å®Œæˆäº†é»˜å¥‘æµ‹è¯•</p>
                </div>

                <!-- æˆç»©æ˜¾ç¤º -->
                <div class="mb-8">
                    <div class="text-7xl font-bold text-gradient bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-4" id="finalScore">0</div>
                    <p class="text-xl text-gray-700 mb-2">
                        ç­”å¯¹ <span id="correctCount" class="font-bold text-green-600">0</span> é¢˜
                    </p>
                    <p class="text-gray-600">å…± <span id="totalCount" class="font-medium">2</span> é¢˜</p>
                </div>

                <!-- é»˜å¥‘ç­‰çº§ -->
                <div class="mb-8">
                    <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium" id="levelBadge">
                        <i class="fa fa-star mr-2"></i>é»˜å¥‘ç­‰çº§
                    </div>
                    <p id="levelDescription" class="text-gray-600 mt-2"></p>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showRanking()" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg font-medium hover:from-blue-600 hover:to-cyan-600 transition-all">
                        <i class="fa fa-bar-chart mr-2"></i>æŸ¥çœ‹æ’è¡Œæ¦œ
                    </button>
                    <button onclick="logout()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                        <i class="fa fa-sign-out mr-2"></i>é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œç•Œé¢ -->
        <div id="rankingSection" class="hidden py-12">
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-trophy text-white text-2xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">é»˜å¥‘æ’è¡Œæ¦œ</h2>
                    <p class="text-gray-600">çœ‹çœ‹è°å’Œæœ‹å‹æœ€æœ‰é»˜å¥‘</p>
                </div>

                <!-- æ’è¡Œæ¦œåŠ è½½çŠ¶æ€ -->
                <div id="rankingLoading" class="text-center py-12">
                    <div class="animate-spin w-12 h-12 border-4 border-purple-200 border-t-purple-500 rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-600">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</p>
                </div>

                <!-- æ’è¡Œæ¦œå†…å®¹ -->
                <div id="rankingContent" class="hidden">
                    <div class="space-y-4" id="rankingList">
                        <!-- æ’è¡Œæ¦œé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å›åˆ°ç»“æœæŒ‰é’® -->
                <div class="text-center mt-8">
                    <button onclick="showResult()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                        <i class="fa fa-arrow-left mr-2"></i>å›åˆ°ç»“æœ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•æ•°æ®
        const QUESTIONS = [
    {
        "id": "q1",
        "question": "ä»–å¤šé«˜ï¼Ÿ",
        "type": "single",
        "options": [
            "175cm",
            "160cm",
            "180cm",
            "195cm"
        ],
        "correctAnswer": "C"
    },
    {
        "id": "q2",
        "question": "è¿™ä¸ªHTMLæ˜¯è°åšçš„ï¼Ÿ",
        "type": "multiple",
        "options": [
            "doubao",
            "726",
            "705"
        ],
        "correctAnswer": [
            "A",
            "B"
        ]
    }
];
        const USERS = [
    {
        "username": "705",
        "passwordHash": "30aa05fdb0e292baaef648a853d3202dded02ffd5a51f37d338d2864cba79710"
    },
    {
        "username": "Public",
        "passwordHash": "a1159e9df3670d549d04524532629f5477ceb7deec9b45e47e8c009506ecb2c8"
    }
];
        const API_KEY = "nOhCXXRtxnemH4STy6RRP1vKmW91FClN";
        const TEST_ID = "cmoPRN8WnzHQ0PCk";
        const MAX_ATTEMPTS = 1;
        const ENCRYPTION_SECRET = "H8qpEEkcA4Tjbh1C";
        
        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizCompleted = false;
        let userAttempts = 0;

        // DOM å…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const alreadyCompletedSection = document.getElementById('alreadyCompletedSection');
        const quizSection = document.getElementById('quizSection');
        const resultSection = document.getElementById('resultSection');
        const rankingSection = document.getElementById('rankingSection');
        const questionContainer = document.getElementById('questionContainer');
        const userInfo = document.getElementById('userInfo');

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åº”ç”¨åˆå§‹åŒ–');
            initializeApp();
        });

        function initializeApp() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•çŠ¶æ€
            const savedUser = localStorage.getItem('currentUser_' + TEST_ID);
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    checkUserAttempts();
                } catch (error) {
                    console.error('åŠ è½½ä¿å­˜çš„ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                    localStorage.removeItem('currentUser_' + TEST_ID);
                    showLogin();
                }
            } else {
                showLogin();
            }

            // ç»‘å®šç™»å½•è¡¨å•äº‹ä»¶
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleLogin();
                });
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            try {
                const passwordHash = await sha256(password);
                const user = USERS.find(u => u.username === username && u.passwordHash === passwordHash);

                if (user) {
                    currentUser = { username: user.username };
                    localStorage.setItem('currentUser_' + TEST_ID, JSON.stringify(currentUser));
                    await checkUserAttempts();
                    showAlert('ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    showAlert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                showAlert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        async function checkUserAttempts() {
            try {
                // è·å–ç”¨æˆ·ç­”é¢˜è®°å½•
                const userRecords = await getUserRecords(currentUser.username);
                userAttempts = userRecords.length;

                if (userAttempts >= MAX_ATTEMPTS) {
                    // æ˜¾ç¤ºå·²å®Œæˆç•Œé¢
                    showAlreadyCompleted();
                    // å°è¯•è·å–ä¸Šæ¬¡æˆç»©
                    if (userRecords.length > 0) {
                        const lastRecord = userRecords[userRecords.length - 1];
                        // è§£å¯†ç­”æ¡ˆ
                        try {
                            const decryptedAnswers = await decryptAnswers(lastRecord.encryptedAnswers);
                            userAnswers = decryptedAnswers;
                        } catch (error) {
                            console.error('è§£å¯†ç­”æ¡ˆå¤±è´¥:', error);
                        }
                    }
                } else {
                    // æ˜¾ç¤ºæµ‹è¯•ç•Œé¢
                    showQuiz();
                    renderQuestion();
                    updateUserInfo();
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç­”é¢˜æ¬¡æ•°å¤±è´¥:', error);
                showQuiz();
                renderQuestion();
                updateUserInfo();
            }
        }

        async function getUserRecords(username) {
            try {
                const records = [];
                
                // ä»localStorageè·å–
                const savedRecords = JSON.parse(localStorage.getItem('quizRecords_' + TEST_ID) || '[]');
                const userLocalRecords = savedRecords.filter(record => record.username === username);
                records.push(...userLocalRecords);
                
                // ä»APIè·å–
                try {
                    const response = await fetch(`https://textdb.online/${API_KEY}`);
                    if (response.ok) {
                        const apiData = await response.text();
                        if (apiData) {
                            const apiRecord = JSON.parse(apiData);
                            if (apiRecord.username === username) {
                                records.push(apiRecord);
                            }
                        }
                    }
                } catch (apiError) {
                    console.warn('APIè·å–å¤±è´¥ï¼Œä½¿ç”¨localStorageæ•°æ®:', apiError);
                }
                
                // å»é‡å¹¶æŒ‰æ—¶é—´æ’åº
                const uniqueRecords = Array.from(new Map(records.map(item => [item.timestamp, item])).values());
                return uniqueRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (error) {
                console.error('è·å–ç”¨æˆ·è®°å½•å¤±è´¥:', error);
                return [];
            }
        }

        function sha256(str) {
            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(str))
                .then(digest => {
                    return Array.from(new Uint8Array(digest))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                });
        }

        async function encryptAnswers(answers) {
            try {
                const answersStr = JSON.stringify(answers);
                const encoder = new TextEncoder();
                const data = encoder.encode(answersStr);
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_SECRET),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(TEST_ID),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                return {
                    iv: Array.from(iv).map(b => b.toString(16).padStart(2, '0')).join(''),
                    data: Array.from(new Uint8Array(encrypted)).map(b => b.toString(16).padStart(2, '0')).join('')
                };
            } catch (error) {
                console.error('åŠ å¯†ç­”æ¡ˆå¤±è´¥:', error);
                throw error;
            }
        }

        async function decryptAnswers(encryptedData) {
            try {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(ENCRYPTION_SECRET),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                );
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(TEST_ID),
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                const iv = new Uint8Array(encryptedData.iv.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                const data = new Uint8Array(encryptedData.data.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (error) {
                console.error('è§£å¯†ç­”æ¡ˆå¤±è´¥:', error);
                throw error;
            }
        }

        function renderQuestion() {
            if (currentQuestionIndex >= QUESTIONS.length) {
                showResult();
                return;
            }

            const question = QUESTIONS[currentQuestionIndex];
            
            let optionsHtml = '';
            const inputType = question.type === 'multiple' ? 'checkbox' : 'radio';
            
            for (let i = 0; i < question.options.length; i++) {
                const optionKey = String.fromCharCode(65 + i);
                const isSelected = question.type === 'multiple' 
                    ? (userAnswers[question.id] || []).includes(optionKey)
                    : userAnswers[question.id] === optionKey;
                
                optionsHtml += `
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-200 ${isSelected ? 'border-primary bg-primary/5 ring-2 ring-primary/20' : ''}">
                        <input type="${inputType}" name="${question.id}" value="${optionKey}" 
                               class="w-5 h-5 text-primary focus:ring-primary"
                               ${isSelected ? 'checked' : ''} onchange="selectAnswer('${question.id}', '${optionKey}', '${question.type}')">
                        <span class="flex-1 ml-4 ${isSelected ? 'text-primary font-medium' : 'text-gray-700'}">
                            <strong class="text-lg">${optionKey}.</strong> ${question.options[i]}
                        </span>
                    </label>
                `;
            }

            // æ·»åŠ é¢˜ç›®ç±»å‹æç¤º
            let questionTypeHtml = '';
            if (question.type === 'multiple') {
                questionTypeHtml = `
                    <div class="mb-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fa fa-check-square-o mr-1"></i>å¤šé€‰é¢˜ï¼ˆå¯é€‰æ‹©å¤šä¸ªç­”æ¡ˆï¼‰
                        </span>
                    </div>
                `;
            }

            questionContainer.innerHTML = `
                <div class="question-card animate-fade-in">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full flex items-center justify-center font-bold text-lg mr-4">
                            ${currentQuestionIndex + 1}
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">${question.question}</h3>
                    </div>
                    
                    ${questionTypeHtml}

                    <div class="space-y-3">
                        ${optionsHtml}
                    </div>
                </div>
            `;

            updateProgress();
            updateNavigation();
        }

        function selectAnswer(questionId, option, questionType) {
            if (questionType === 'multiple') {
                // å¤šé€‰é¢˜é€»è¾‘
                if (!userAnswers[questionId]) {
                    userAnswers[questionId] = [];
                }
                const index = userAnswers[questionId].indexOf(option);
                if (index > -1) {
                    userAnswers[questionId].splice(index, 1);
                } else {
                    userAnswers[questionId].push(option);
                }
            } else {
                // å•é€‰é¢˜é€»è¾‘
                userAnswers[questionId] = option;
            }
            
            updateNavigation();
            
            // æ·»åŠ é€‰æ‹©åŠ¨ç”»
            const label = document.querySelector(`input[value="${option}"][name="${questionId}"]`).closest('label');
            if (label) {
                label.classList.add('scale-102');
                setTimeout(() => label.classList.remove('scale-102'), 200);
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / QUESTIONS.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentQuestionIndex + 1}/${QUESTIONS.length}`;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentQuestion = QUESTIONS[currentQuestionIndex];

            prevBtn.disabled = currentQuestionIndex === 0;
            
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©ç­”æ¡ˆ
            let hasAnswer = false;
            if (currentQuestion.type === 'multiple') {
                hasAnswer = (userAnswers[currentQuestion.id] || []).length > 0;
            } else {
                hasAnswer = !!userAnswers[currentQuestion.id];
            }
            
            nextBtn.disabled = !hasAnswer;

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if (currentQuestionIndex === QUESTIONS.length - 1) {
                nextBtn.innerHTML = '<i class="fa fa-check mr-2"></i>æäº¤ç­”æ¡ˆ';
            } else {
                nextBtn.innerHTML = 'ä¸‹ä¸€é¢˜<i class="fa fa-arrow-right ml-2"></i>';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < QUESTIONS.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({top: 0, behavior: 'smooth'});
            } else {
                submitQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        async function submitQuiz() {
            if (quizCompleted) return;

            try {
                // è®¡ç®—å¾—åˆ†
                let correct = 0;
                QUESTIONS.forEach(question => {
                    if (question.type === 'multiple') {
                        // å¤šé€‰é¢˜å¾—åˆ†é€»è¾‘ï¼šæ‰€æœ‰æ­£ç¡®ç­”æ¡ˆéƒ½é€‰å¯¹æ‰ç®—å¯¹
                        const userAnswer = userAnswers[question.id] || [];
                        const correctAnswers = question.correctAnswer;
                        const isAllCorrect = correctAnswers.every(answer => userAnswer.includes(answer));
                        const noExtraAnswers = userAnswer.every(answer => correctAnswers.includes(answer));
                        if (isAllCorrect && noExtraAnswers) {
                            correct++;
                        }
                    } else {
                        // å•é€‰é¢˜å¾—åˆ†é€»è¾‘
                        if (userAnswers[question.id] === question.correctAnswer) {
                            correct++;
                        }
                    }
                });

                const score = Math.round((correct / QUESTIONS.length) * 100);
                
                // åŠ å¯†ç­”æ¡ˆ
                const encryptedAnswers = await encryptAnswers(userAnswers);
                
                // ä¿å­˜æˆç»©
                await saveScore(score, correct, encryptedAnswers);
                
                quizCompleted = true;
                showResult();
            } catch (error) {
                console.error('æäº¤æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                showAlert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        async function saveScore(score, correctAnswers, encryptedAnswers) {
            try {
                const scoreData = {
                    username: currentUser.username,
                    score: score,
                    correctAnswers: correctAnswers,
                    totalQuestions: QUESTIONS.length,
                    timestamp: new Date().toISOString(),
                    testId: TEST_ID,
                    encryptedAnswers: encryptedAnswers
                };

                // ä¿å­˜åˆ°localStorageï¼ˆå¤‡ç”¨ï¼‰
                const savedRecords = JSON.parse(localStorage.getItem('quizRecords_' + TEST_ID) || '[]');
                savedRecords.push(scoreData);
                localStorage.setItem('quizRecords_' + TEST_ID, JSON.stringify(savedRecords));

                // å°è¯•ä¿å­˜åˆ°API
                try {
                    const response = await fetch(`https://api.textdb.online/update/?key=${API_KEY}&value=${encodeURIComponent(JSON.stringify(scoreData))}`);
                    if (!response.ok) {
                        console.warn('APIä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨localStorage');
                    }
                } catch (apiError) {
                    console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨localStorage:', apiError);
                }

                return scoreData;
            } catch (error) {
                console.error('ä¿å­˜æˆç»©å¤±è´¥:', error);
                throw error;
            }
        }

        function showResult() {
            const correct = Object.values(userAnswers).filter((answer, index) => {
                const question = QUESTIONS[index];
                if (question.type === 'multiple') {
                    const userAnswer = answer || [];
                    const correctAnswers = question.correctAnswer;
                    return correctAnswers.every(a => userAnswer.includes(a)) && 
                           userAnswer.every(a => correctAnswers.includes(a));
                } else {
                    return answer === question.correctAnswer;
                }
            }).length;
            
            const score = Math.round((correct / QUESTIONS.length) * 100);
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('totalCount').textContent = QUESTIONS.length;
            
            // æ›´æ–°é»˜å¥‘ç­‰çº§
            updateLevel(score);
            
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateLevel(score) {
            const levelBadge = document.getElementById('levelBadge');
            const levelDescription = document.getElementById('levelDescription');
            
            let level, color, icon, description;
            
            if (score >= 90) {
                level = 'å®Œç¾é»˜å¥‘';
                color = 'bg-gradient-to-r from-yellow-400 to-orange-500';
                icon = 'fa-diamond';
                description = 'ä½ ä»¬ç®€ç›´æ˜¯å¿ƒçµç›¸é€šçš„æœ€ä½³æ‹æ¡£ï¼';
            } else if (score >= 80) {
                level = 'é«˜åº¦é»˜å¥‘';
                color = 'bg-gradient-to-r from-blue-500 to-cyan-500';
                icon = 'fa-star';
                description = 'ä½ ä»¬æœ‰ç€éå¸¸å¥½çš„é»˜å¥‘ï¼Œå½¼æ­¤å¾ˆäº†è§£ï¼';
            } else if (score >= 70) {
                level = 'è‰¯å¥½é»˜å¥‘';
                color = 'bg-gradient-to-r from-green-500 to-emerald-500';
                icon = 'fa-thumbs-up';
                description = 'ä½ ä»¬çš„é»˜å¥‘ä¸é”™ï¼Œç»§ç»­ä¿æŒï¼';
            } else if (score >= 60) {
                level = 'ä¸€èˆ¬é»˜å¥‘';
                color = 'bg-gradient-to-r from-purple-500 to-pink-500';
                icon = 'fa-heart';
                description = 'ä½ ä»¬æœ‰ä¸€å®šé»˜å¥‘ï¼Œè¿˜å¯ä»¥æ›´äº†è§£å½¼æ­¤ï¼';
            }  else if (score >= 40) {
                level = 'éœ€è¦åŠªåŠ›';
                color = 'bg-gradient-to-r from-red-500 to-pink-500';
                icon = 'fa-heart-o';
                description = 'æˆ‘ä»¬nå¹´çš„åŒå­¦æƒ…è°Šå‘¢?!!';
            }  else if (score <= 20) {
                level = 'ä½ è°å•Šï¼';
                color = 'bg-gradient-to-r from-red-500 to-pink-500';
                icon = 'fa-heart-o';
                description = 'çº¯è’™çš„éƒ½æ¯”ä½ å¼º';
            }else {
                level = 'éœ€è¦åŠªåŠ›';
                color = 'bg-gradient-to-r from-red-500 to-pink-500';
                icon = 'fa-heart-o';
                description = 'åŠ æ²¹ï¼å¤šäº†è§£æœ‹å‹ï¼Œå¢è¿›å½¼æ­¤çš„é»˜å¥‘å§ï¼';
            }
            
            levelBadge.className = `inline-flex items-center px-4 py-2 rounded-full text-sm font-medium text-white ${color}`;
            levelBadge.innerHTML = `<i class="fa ${icon} mr-2"></i>${level}`;
            levelDescription.textContent = description;
        }

        async function showRanking() {
            resultSection.classList.add('hidden');
            rankingSection.classList.remove('hidden');
            
            try {
                const rankings = await getRankings();
                displayRankings(rankings);
            } catch (error) {
                console.error('è·å–æ’è¡Œæ¦œå¤±è´¥:', error);
                showAlert('åŠ è½½æ’è¡Œæ¦œå¤±è´¥', 'error');
            }
        }

        async function getRankings() {
            try {
                // å…ˆä»localStorageè·å–
                const savedRecords = JSON.parse(localStorage.getItem('quizRecords_' + TEST_ID) || '[]');
                
                // å°è¯•ä»APIè·å–
                try {
                    const response = await fetch(`https://textdb.online/${API_KEY}`);
                    if (response.ok) {
                        const apiData = await response.text();
                        if (apiData) {
                            const apiRecord = JSON.parse(apiData);
                            savedRecords.push(apiRecord);
                        }
                    }
                } catch (apiError) {
                    console.warn('APIè·å–å¤±è´¥ï¼Œä½¿ç”¨localStorageæ•°æ®:', apiError);
                }
                
                // å»é‡å’Œæ’åº
                const uniqueRecords = Array.from(new Map(savedRecords.map(item => [item.username + item.timestamp, item])).values());
                return uniqueRecords.sort((a, b) => b.score - a.score);
            } catch (error) {
                console.error('è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', error);
                return [];
            }
        }

        function displayRankings(rankings) {
            const rankingList = document.getElementById('rankingList');
            const rankingLoading = document.getElementById('rankingLoading');
            const rankingContent = document.getElementById('rankingContent');
            
            rankingLoading.classList.add('hidden');
            rankingContent.classList.remove('hidden');
            
            if (rankings.length === 0) {
                rankingList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fa fa-frown-o text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">æš‚æ— æ’åæ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            rankingList.innerHTML = rankings.map((item, index) => {
                const isCurrentUser = currentUser && item.username === currentUser.username;
                const medal = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : `${index + 1}.`;
                
                return `
                    <div class="flex items-center justify-between p-4 rounded-lg transition-all duration-200 ${isCurrentUser ? 'bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200' : 'hover:bg-gray-50'}">
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl font-bold ${index < 3 ? '' : 'text-gray-500'}">${medal}</span>
                            <div>
                                <div class="font-medium ${isCurrentUser ? 'text-purple-600' : 'text-gray-900'}">${item.username}</div>
                                <div class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-purple-600">${item.score}</div>
                            <div class="text-sm text-gray-500">${item.correctAnswers}/${item.totalQuestions}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAlreadyCompleted() {
            loginSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
            alreadyCompletedSection.classList.remove('hidden');
            updateUserInfo();
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            alreadyCompletedSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
        }

        function showQuiz() {
            loginSection.classList.add('hidden');
            alreadyCompletedSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
        }

        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                currentUser = null;
                currentQuestionIndex = 0;
                userAnswers = {};
                quizCompleted = false;
                userAttempts = 0;
                
                localStorage.removeItem('currentUser_' + TEST_ID);
                
                rankingSection.classList.add('hidden');
                resultSection.classList.add('hidden');
                quizSection.classList.add('hidden');
                alreadyCompletedSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
                
                // æ¸…ç©ºç™»å½•è¡¨å•
                document.getElementById('loginForm').reset();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                const userInfoText = userInfo.querySelector('span');
                userInfoText.textContent = `æ¬¢è¿ï¼Œ${currentUser.username}`;
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
            } else {
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
        }

        function showAlert(message, type = 'info') {
            // åˆ›å»ºæç¤ºæ¡†
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 transition-all duration-300 transform translate-x-full`;
            
            switch(type) {
                case 'success':
                    alertDiv.classList.add('bg-green-500');
                    alertDiv.innerHTML = `<i class="fa fa-check mr-2"></i>${message}`;
                    break;
                case 'error':
                    alertDiv.classList.add('bg-red-500');
                    alertDiv.innerHTML = `<i class="fa fa-times mr-2"></i>${message}`;
                    break;
                default:
                    alertDiv.classList.add('bg-blue-500');
                    alertDiv.innerHTML = `<i class="fa fa-info mr-2"></i>${message}`;
            }
            
            document.body.appendChild(alertDiv);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                alertDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 300);
            }, 3000);
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fade-in 0.3s ease-out;
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>