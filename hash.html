
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速加密工具</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <i class="fa fa-magic text-2xl text-green-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">快速加密工具</h1>
                <p class="text-gray-500 mt-2">一键生成静态网站的密码保护配置</p>
            </div>

            <!-- 主要配置区域 -->
            <div class="space-y-6">
                <!-- 密码设置 -->
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">设置访问密码</label>
                    <div class="relative">
                        <input type="password" id="password" 
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-200"
                               placeholder="请输入强密码（建议至少12位）">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                            <i class="fa fa-lock"></i>
                        </span>
                    </div>
                    <div id="passwordStrength" class="hidden mt-2 text-sm">
                        <span id="strengthText" class="font-medium"></span>
                        <div id="strengthBar" class="w-full h-1 mt-1 rounded-full bg-gray-200">
                            <div id="strengthFill" class="h-full rounded-full transition-all duration-300"></div>
                        </div>
                    </div>
                </div>

                <!-- 内容类型和内容 -->
                <div class="space-y-4">
                    <div>
                        <label for="contentType" class="block text-sm font-medium text-gray-700 mb-2">内容类型</label>
                        <select id="contentType" 
                                class="w-full pl-3 pr-8 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="html">HTML内容</option>
                            <option value="text">纯文本</option>
                            <option value="url">URL链接</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="contentToEncrypt" class="block text-sm font-medium text-gray-700 mb-2">要加密的内容</label>
                        <div class="relative">
                            <textarea id="contentToEncrypt" rows="4"
                                      class="w-full pl-3 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y"
                                      placeholder="输入HTML、文本或URL"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 生成按钮 -->
                <button id="generateBtn" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-lg">
                    <i class="fa fa-rocket mr-2"></i>
                    一键生成配置
                </button>
            </div>

            <!-- 结果显示区域 -->
            <div id="resultSection" class="hidden mt-8 pt-8 border-t border-gray-200">
                <div class="bg-green-50 border border-green-100 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <div class="inline-flex items-center justify-center w-8 h-8 bg-green-100 rounded-full mr-3">
                            <i class="fa fa-check text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-green-800">配置生成成功！</h3>
                            <p class="text-sm text-green-700">点击复制按钮，然后粘贴到 secure-page.html 中</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <div class="bg-gray-800 px-4 py-2 flex items-center justify-between">
                        <div class="flex space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-400 text-xs">secure-page.html 配置</span>
                            <button id="copyConfigBtn" 
                                    class="text-gray-400 hover:text-white text-xs flex items-center">
                                <i class="fa fa-copy mr-1"></i>
                                复制
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <pre id="configCode" class="text-sm font-mono overflow-x-auto bg-transparent border-none"></pre>
                    </div>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="copyAgainBtn" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                        <i class="fa fa-copy mr-2"></i>
                        重新复制代码
                    </button>
                    <button id="newConfigBtn" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                        <i class="fa fa-bullseye mr-2"></i>
                        生成新配置
                    </button>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-info-circle text-blue-600 mr-2"></i>
                使用说明
            </h2>
            <div class="grid md:grid-cols-3 gap-6 text-sm">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 rounded-full mb-3">
                        <span class="text-blue-600 font-bold">1</span>
                    </div>
                    <h3 class="font-medium text-gray-800 mb-2">设置密码</h3>
                    <p class="text-gray-600">创建一个强密码，工具会自动评估密码强度</p>
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-green-100 rounded-full mb-3">
                        <span class="text-green-600 font-bold">2</span>
                    </div>
                    <h3 class="font-medium text-gray-800 mb-2">输入内容</h3>
                    <p class="text-gray-600">选择内容类型并输入要加密的HTML、文本或URL</p>
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-purple-100 rounded-full mb-3">
                        <span class="text-purple-600 font-bold">3</span>
                    </div>
                    <h3 class="font-medium text-gray-800 mb-2">生成配置</h3>
                    <p class="text-gray-600">一键生成配置代码，复制到安全验证页面即可使用</p>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-100 rounded-lg">
                <h4 class="font-medium text-yellow-800 mb-2">
                    <i class="fa fa-exclamation-triangle mr-1"></i>
                    安全提醒
                </h4>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>• 使用强密码（至少12位，包含大小写字母、数字和特殊字符）</li>
                    <li>• 不要在公共场所使用此工具生成敏感信息</li>
                    <li>• 保存好您的密码，丢失后无法恢复加密内容</li>
                    <li>• 建议定期更换密码并重新加密内容</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let generatedConfig = null;
        const PBKDF2_ITERATIONS = 200000; // 固定迭代次数，与secure-page.html保持一致

        // 工具函数
        function copyToClipboard(text) {
            return navigator.clipboard.writeText(text);
        }

        function generateSalt(length = 16) {
            const array = new Uint8Array(length);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => ('0' + (byte & 0xFF).toString(16)).slice(-2)).join('');
        }

        // 密码强度检测
        function checkPasswordStrength(password) {
            const strengthElement = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');
            const strengthFill = document.getElementById('strengthFill');
            
            if (!password) {
                strengthElement.classList.add('hidden');
                return;
            }
            
            let strength = 0;
            let strengthLabel = '';
            let strengthColor = '';
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch(strength) {
                case 0:
                case 1:
                    strengthLabel = '非常弱';
                    strengthColor = 'bg-red-500';
                    break;
                case 2:
                    strengthLabel = '弱';
                    strengthColor = 'bg-orange-500';
                    break;
                case 3:
                    strengthLabel = '中等';
                    strengthColor = 'bg-yellow-500';
                    break;
                case 4:
                    strengthLabel = '强';
                    strengthColor = 'bg-green-400';
                    break;
                case 5:
                    strengthLabel = '非常强';
                    strengthColor = 'bg-green-600';
                    break;
            }
            
            strengthElement.classList.remove('hidden');
            strengthText.textContent = `密码强度: ${strengthLabel}`;
            strengthFill.className = `h-full rounded-full transition-all duration-300 ${strengthColor}`;
            strengthFill.style.width = `${(strength / 5) * 100}%`;
            
            return strength >= 3; // 至少中等强度
        }

        // 主生成函数
        async function generateConfig() {
            const password = document.getElementById('password').value;
            const contentType = document.getElementById('contentType').value;
            const contentToEncrypt = document.getElementById('contentToEncrypt').value;
            
            // 验证输入
            if (!password) {
                alert('请输入访问密码');
                document.getElementById('password').focus();
                return false;
            }
            
            if (!contentToEncrypt) {
                alert('请输入要加密的内容');
                document.getElementById('contentToEncrypt').focus();
                return false;
            }
            
            // 密码强度检查
            const passwordStrongEnough = checkPasswordStrength(password);
            if (!passwordStrongEnough && password.length < 8) {
                // if (!confirm('密码强度较弱，建议使用更强的密码。是否继续？')) {
                //     return false;
                // }
            }
            
            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;
            
            try {
                // 显示加载状态
                generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>生成中...';
                generateBtn.disabled = true;
                
                // 生成盐值
                const salt = generateSalt();
                
                // 生成密码哈希
                const encoder = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw",
                    encoder.encode(password),
                    { name: "PBKDF2" },
                    false,
                    ["deriveBits", "deriveKey"]
                );
                
                const derivedBits = await window.crypto.subtle.deriveBits(
                    {
                        name: "PBKDF2",
                        salt: encoder.encode(salt),
                        iterations: PBKDF2_ITERATIONS,
                        hash: "SHA-256"
                    },
                    keyMaterial,
                    256
                );
                
                const storedHash = Array.from(new Uint8Array(derivedBits))
                    .map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2))
                    .join('');
                
                // 生成加密密钥
                const encryptionKey = await window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: encoder.encode(salt),
                        iterations: PBKDF2_ITERATIONS,
                        hash: "SHA-256"
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt"]
                );
                
                // 加密内容
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await window.crypto.subtle.encrypt(
                    {
                        name: "AES-GCM",
                        iv: iv
                    },
                    encryptionKey,
                    encoder.encode(contentToEncrypt)
                );
                
                // 分离密文和认证标签
                const encryptedArray = new Uint8Array(encrypted);
                const authTag = encryptedArray.slice(-16);
                const ciphertext = encryptedArray.slice(0, -16);
                
                const encryptedContent = Array.from(ciphertext)
                    .map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2))
                    .join('');
                
                const contentIv = Array.from(iv)
                    .map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2))
                    .join('');
                
                const contentAuthTag = Array.from(authTag)
                    .map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2))
                    .join('');
                
                // 生成配置代码
                const configCode = `
const config = {
    storedHash: "${storedHash}",
    storedSalt: "${salt}",
    encryptedContent: "${encryptedContent}",
    contentIv: "${contentIv}",
    contentAuthTag: "${contentAuthTag}",
    contentType: "${contentType}" // 可选值: html, text, url
};`;
                
                // 保存生成的配置
                generatedConfig = {
                    code: configCode,
                    hash: storedHash,
                    salt: salt,
                    encryptedContent: encryptedContent,
                    iv: contentIv,
                    authTag: contentAuthTag,
                    type: contentType
                };
                
                // 显示结果
                document.getElementById('configCode').textContent = configCode;
                document.getElementById('resultSection').classList.remove('hidden');
                
                // 自动复制
                await copyToClipboard(configCode);
                
                // 平滑滚动到结果区域
                document.getElementById('resultSection').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                return true;
                
            } catch (error) {
                console.error('生成配置时出错:', error);
                alert('生成配置时出错，请重试');
                return false;
            } finally {
                // 恢复按钮状态
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // 事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 密码强度实时检测
            document.getElementById('password').addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });
            
            // 生成按钮点击
            document.getElementById('generateBtn').addEventListener('click', generateConfig);
            
            // 复制按钮点击
            document.getElementById('copyConfigBtn').addEventListener('click', async function() {
                if (generatedConfig) {
                    await copyToClipboard(generatedConfig.code);
                    this.innerHTML = '<i class="fa fa-check mr-1"></i>已复制';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fa fa-copy mr-1"></i>复制';
                    }, 2000);
                }
            });
            
            // 重新复制按钮
            document.getElementById('copyAgainBtn').addEventListener('click', async function() {
                if (generatedConfig) {
                    await copyToClipboard(generatedConfig.code);
                    this.innerHTML = '<i class="fa fa-check mr-2"></i>已复制';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fa fa-copy mr-2"></i>重新复制代码';
                    }, 2000);
                }
            });
            
            // 生成新配置按钮
            document.getElementById('newConfigBtn').addEventListener('click', function() {
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('password').focus();
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter 生成配置
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateConfig();
                }
            });
        });
    </script>
</body>
</html>