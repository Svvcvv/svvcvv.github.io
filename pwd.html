
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全访问验证</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen flex items-center justify-center p-4">
    <!-- 验证界面 -->
    <div id="loginForm" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md transform transition-all duration-500 hover:shadow-2xl">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                <i class="fa fa-shield text-2xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800">安全访问</h1>
            <p class="text-gray-500 mt-2">此内容受密码保护，请输入访问密码</p>
        </div>

        <form id="verifyForm" class="space-y-6">
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">访问密码</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                        <i class="fa fa-lock"></i>
                    </span>
                    <input type="password" id="password" name="password" 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                           placeholder="请输入密码" required>
                </div>
            </div>

            <div id="errorMessage" class="hidden p-3 bg-red-50 border border-red-100 rounded-lg text-sm text-red-600">
                <i class="fa fa-exclamation-circle mr-1"></i>
                <span>密码不正确，请重试</span>
            </div>

            <div id="loadingIndicator" class="hidden p-3 bg-blue-50 border border-blue-100 rounded-lg text-sm text-blue-600">
                <i class="fa fa-spinner fa-spin mr-1"></i>
                <span>正在验证并加载内容...</span>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                <i class="fa fa-unlock-alt mr-2"></i>
                验证并访问
            </button>
        </form>

        <div class="mt-6 text-center text-sm text-gray-500">
            <p>如果您忘记了密码，请联系内容提供者</p>
        </div>
    </div>

    <!-- 解密成功后的内容显示区域 -->
    <div id="contentArea" class="hidden w-full max-w-4xl mx-auto">
        <!-- 内容头部 -->
        <div class="bg-white rounded-t-2xl shadow-xl p-6 md:p-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-green-100 rounded-full mr-4">
                        <i class="fa fa-check text-xl text-green-600"></i>
                    </div>
                    <div>
                        <h1 id="contentTitle" class="text-2xl font-bold text-gray-800">内容已解锁</h1>
                        <p class="text-gray-500 mt-1">您已成功验证身份，可以访问受保护的内容</p>
                    </div>
                </div>
                <button id="logoutBtn" 
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition duration-200 flex items-center">
                    <i class="fa fa-sign-out mr-2"></i>
                    退出
                </button>
            </div>
        </div>

        <!-- 内容主体 -->
        <div id="decryptedContent" class="bg-white rounded-b-2xl shadow-xl p-6 md:p-8 min-h-[500px]">
            <!-- 解密后的内容将在这里显示 -->
        </div>
    </div>

    <script>

const config = {
    storedHash: "ed37cf2b18a765a17653d4e0b4accbd8d6805c7cb604256340967e8582d4e613",
    storedSalt: "44e85d6f8b9d8e5fe3a2992732490f28",
    encryptedContent: "71421ba1b927af2f7530796b33c1863b43dd6a0dc205b6463f31",
    contentIv: "cc180be044cb7494333371f9",
    contentAuthTag: "1b72270ab1f4a6ca26268071a30b963c",
    contentType: "url" // 可选值: html, text, url
};
        // ================================
        // 工具函数
        // ================================

        // 十六进制字符串转Uint8Array
        function hexStringToUint8Array(hexString) {
            const bytes = new Uint8Array(hexString.length / 2);
            for (let i = 0; i < bytes.length; i++) {
                bytes[i] = parseInt(hexString.substr(i * 2, 2), 16);
            }
            return bytes;
        }

        // 验证密码是否正确
        async function verifyPassword(inputPassword, storedHash, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                encoder.encode(inputPassword),
                { name: "PBKDF2" },
                false,
                ["deriveBits"]
            );
            
            const derivedBits = await window.crypto.subtle.deriveBits(
                {
                    name: "PBKDF2",
                    salt: encoder.encode(salt),
                    iterations: 200000, // 与生成器保持一致
                    hash: "SHA-256"
                },
                keyMaterial,
                256
            );
            
            const inputHash = Array.from(new Uint8Array(derivedBits))
                .map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2))
                .join('');
            
            return inputHash === storedHash;
        }

        // 解密内容
        async function decryptContent(encryptedData, iv, tag, password, salt) {
            const encoder = new TextEncoder();
            const decoder = new TextDecoder();
            
            const ciphertext = hexStringToUint8Array(encryptedData);
            const ivArray = hexStringToUint8Array(iv);
            const tagArray = hexStringToUint8Array(tag);
            
            // 组合密文和认证标签
            const combined = new Uint8Array(ciphertext.length + tagArray.length);
            combined.set(ciphertext);
            combined.set(tagArray, ciphertext.length);
            
            // 生成密钥
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );
            
            const key = await window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: encoder.encode(salt),
                    iterations: 200000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["decrypt"]
            );
            
            // 解密
            const decrypted = await window.crypto.subtle.decrypt(
                {
                    name: "AES-GCM",
                    iv: ivArray
                },
                key,
                combined
            );
            
            return decoder.decode(decrypted);
        }

        // 显示解密后的内容
        function displayContent(content, type) {
            const contentArea = document.getElementById('contentArea');
            const decryptedContent = document.getElementById('decryptedContent');
            const loginForm = document.getElementById('loginForm');

            switch(type) {
                case 'html':
                    decryptedContent.innerHTML = content;
                    break;
                case 'text':
                    decryptedContent.innerHTML = `<pre class="bg-gray-50 p-4 rounded-lg text-sm overflow-x-auto">${escapeHtml(content)}</pre>`;
                    break;
                case 'url':
                    // 验证URL格式
                    if (isValidUrl(content)) {
                        decryptedContent.innerHTML = `
                            <div class="text-center py-12">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-6">
                                    <i class="fa fa-external-link text-3xl text-blue-600"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">正在跳转到目标页面...</h3>
                                <p class="text-gray-500 mb-6">如果没有自动跳转，请点击下方按钮</p>
                                <a href="${escapeHtml(content)}" target="_self" 
                                   class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-300">
                                    <i class="fa fa-arrow-right mr-2"></i>
                                    立即访问
                                </a>
                            </div>
                        `;
                        // 自动跳转
                        setTimeout(() => {
                            window.location.href = content;
                        }, 3000);
                    } else {
                        decryptedContent.innerHTML = `
                            <div class="text-center py-12">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-6">
                                    <i class="fa fa-exclamation-triangle text-3xl text-red-600"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">无效的URL</h3>
                                <p class="text-gray-500">解密后的内容不是有效的URL格式</p>
                            </div>
                        `;
                    }
                    break;
                default:
                    decryptedContent.innerHTML = `<p class="text-gray-500">未知的内容类型</p>`;
            }

            // 切换显示
            loginForm.classList.add('hidden');
            contentArea.classList.remove('hidden');
            
            // 添加淡入动画
            setTimeout(() => {
                contentArea.classList.add('animate-fadeIn');
            }, 100);
        }

        // 验证URL格式
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // HTML转义
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ================================
        // 事件处理
        // ================================

        // 表单提交处理
        document.getElementById('verifyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const submitBtn = this.querySelector('button[type="submit"]');

            // 验证配置是否完整
            if (!config.storedHash || config.storedHash === "YOUR_GENERATED_HASH" ||
                !config.storedSalt || config.storedSalt === "YOUR_GENERATED_SALT" ||
                !config.encryptedContent || config.encryptedContent === "YOUR_ENCRYPTED_CONTENT" ||
                !config.contentIv || config.contentIv === "YOUR_CONTENT_IV" ||
                !config.contentAuthTag || config.contentAuthTag === "YOUR_CONTENT_AUTH_TAG") {
                alert('请先使用 hash-generator.html 生成加密参数，并更新本页面的配置');
                return;
            }

            try {
                // 显示加载状态
                errorMessage.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>验证中...';

                // 验证密码
                const isPasswordValid = await verifyPassword(password, config.storedHash, config.storedSalt);
                
                if (isPasswordValid) {
                    // 密码正确，解密内容
                    const decryptedContent = await decryptContent(
                        config.encryptedContent,
                        config.contentIv,
                        config.contentAuthTag,
                        password,
                        config.storedSalt
                    );
                    
                    // 显示内容
                    displayContent(decryptedContent, config.contentType);
                } else {
                    // 密码错误
                    errorMessage.classList.remove('hidden');
                    errorMessage.classList.add('animate-shake');
                    setTimeout(() => {
                        errorMessage.classList.remove('animate-shake');
                    }, 500);
                }
            } catch (error) {
                console.error('验证过程出错:', error);
                alert('验证过程中出现错误，请重试');
            } finally {
                // 隐藏加载状态
                loadingIndicator.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-unlock-alt mr-2"></i>验证并访问';
            }
        });

        // 退出按钮事件
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('确定要退出吗？您将需要重新输入密码才能再次访问。')) {
                window.location.reload();
            }
        });

        // 键盘事件处理
        document.getElementById('password').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('verifyForm').dispatchEvent(new Event('submit'));
            }
        });
    </script>

    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</body>
</html>